<!DOCTYPE html>
<html lang="hr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Lokacija Tramvaja</title>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<style>
			#map {
				height: 500px;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<h2>Trenutna lokacija tramvaja linije 5</h2>
		<div id="map"></div>
		<script>
			const map = L.map("map").setView([45.8131696208383, 15.957825798667], 14);
			L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution: "&copy; OpenStreetMap contributors",
			}).addTo(map);

			let prvi = 0;
			let markers = []; // Spremat će sve markere

			async function fetchTramLocation() {
				try {
					const response = await fetch(
						"https://zet.prometko.cyou/vehicles/locations"
					);
					const data = await response.json();
					const trams = data.features.filter(
						(f) => f.properties.routeId === "5"
					);
					console.log(trams);

					// Prvo uklonimo stare markere
					markers.forEach((marker) => map.removeLayer(marker));
					markers = [];

					let firstTram = null;

					for (const tram of trams) {
						const [lon, lat] = tram.geometry.coordinates;

						if (!firstTram) {
							firstTram = { lat, lon }; // Sprema prvu lokaciju za kasniju upotrebu
						}

						// Kreiraj novi marker i dodaj ga na mapu
						const newMarker = L.marker([lat, lon])
							.addTo(map)
							.bindPopup(`Tramvaj ${tram.properties.vehicleId}`);

						markers.push(newMarker); // Spremi marker u niz
					}

					// Ako je prvi tramvaj pronađen, postavi pogled na njegovu lokaciju
					if (firstTram && prvi === 0) {
						map.setView([firstTram.lat, firstTram.lon], 14);
						prvi = 1;
					}
				} catch (error) {
					console.error("Greška kod dohvaćanja podataka:", error);
				}
			}

			fetchTramLocation();
			setInterval(fetchTramLocation, 500);
		</script>
	</body>
</html>
